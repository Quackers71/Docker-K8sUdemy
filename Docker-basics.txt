## Docker Basics

# This is a duplicate from my Docker Repo

# Installing the latest Docker on Linux...

https://get.docker.com/
curl -fsSL get.docker.com -o get-docker.sh
sh get-docker.sh
sudo usermod -aG docker ubuntu # to run docker commands as sudo

# next install docker machine
https://docs.docker.com/machine/install-machine/

$ base=https://github.com/docker/machine/releases/download/v0.14.0 &&
  curl -L $base/docker-machine-$(uname -s)-$(uname -m) >/tmp/docker-machine &&
  sudo install /tmp/docker-machine /usr/local/bin/docker-machine

docker-machine version # to test docker machine has install correctly

# Alternatively for docker machine download via Github
https://github.com/docker/machine/releases

curl -L https://github.com/docker/machine/releases/download/v0.15.0/docker-machine-$(uname -s)-$(uname -m) >/tmp/docker-machine &&
chmod +x /tmp/docker-machine &&
sudo cp /tmp/docker-machine /usr/local/bin/docker-machine


# last install docker compose
https://docs.docker.com/compose/install/#install-compose

sudo curl -L "https://github.com/docker/compose/releases/download/1.22.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# Alternatively for docker compose download via Github
https://github.com/docker/compose/releases

sudo -i
curl -L https://github.com/docker/compose/releases/download/1.22.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

docker-compose version

## docker-and-kubernetes-the-complete-guide

## Section 1: Dive into Docker

# 8. Using the Docker Client

docker run hello-world # this acually failed so ran
docker login
docker run hello-world

## Section 2: Manipulating Containers with the Docker Client

# 12. Overriding Default Commands
docker run busybox echo hi there
# Output "hi there"

docker run busybox ls
bin
dev
etc
...
...
# These are folders that belong on the busybox image

# 13. Listing Running Containers

docker run busybox ping google.com
docker ps # In a 2nd Terminal - You will see the running Container
# Container ID | Image   | Command 			 | Created 		| Status	 | Ports | Names
# 14aded86a0cd | busybox | "ping.google.com" | 25 secs ago  | Up 23 secs | 		 | epic_coriander

docker ps 
# Lists Running Containers

docker ps --all
# Lists All Containers that are or have ever ran

docker run = docker create + docker start

ubuntu@ip-172-31-27-210:~$ docker create hello-world
451d918f0f923a7eb7aba3300f5e3bb3a629a67cf7918081683ea33019b2eea6
ubuntu@ip-172-31-27-210:~$ docker start 451d918f0f923a7eb7aba3300f5e3bb3a629a67cf7918081683ea33019b2eea6
451d918f0f923a7eb7aba3300f5e3bb3a629a67cf7918081683ea33019b2eea6

docker system prune
docker create busybox echo hi there
docker start -a 3cf2305fb276ee6a7c932f82a5fd7bee5537323c1de3853dd8de7840e79fac23
docker ps -a
docker create busybox ping google.com
docker start 119af6e7db41e13b85b2c59efaeb119229f3e87f4c7d5de3b89b5f11d78812b3
docker logs 119af6e7db41e13b85b2c59efaeb119229f3e87f4c7d5de3b89b5f11d78812b3
docker ps
docker logs 119af6e7db41e13b85b2c59efaeb119229f3e87f4c7d5de3b89b5f11d78812b3
docker stop 119af6e7db41e13b85b2c59efaeb119229f3e87f4c7d5de3b89b5f11d78812b3
docker start 119af6e7db41e13b85b2c59efaeb119229f3e87f4c7d5de3b89b5f11d78812b3
docker kill 119af6e7db41e13b85b2c59efaeb119229f3e87f4c7d5de3b89b5f11d78812b3


docker run --name redisinstance -d redis
ubuntu@ip-172-31-27-210:~$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
0701cb4f73c9        redis               "docker-entrypoint.s…"   7 minutes ago       Up 7 minutes        6379/tcp            redisinstance

docker exec -ti redisinstance sh
docker exec -ti redisinstance redis-cli

STDIN	|	STDOUT	|	STDERR

bash	|	powershell	|	zsh	|	sh

docker run -ti busybox sh # Ran from 1st Terminal
docker run -ti busybox sh # Ran from 2nd Terminal
docker ps # Ran from 3rd Terminal
CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS               NAMES
da22b429a1db        busybox             "sh"                     About a minute ago   Up About a minute                       ecstatic_goldstine
e451b5a7f25e        busybox             "sh"                     About a minute ago   Up About a minute                       suspicious_heyrovsky

touch hithere # File create on 1st Terminal
ls # ran on 2nd Terminal has no association on 1st Terminal

## Section 3: Building Custom Images Through Docker Server

mkdir redis-server
cd redis-server


vim Dockerfile

[
# Use an existing docker image as a base
FROM alpine

# Download and install a dependency
RUN apk add --update redis

# Tell the image what to do when it starts as a container
CMD ["redis-server"]

# Save the File :wq
]


ubuntu@ip-172-31-27-210:~/redis-image$ docker build .    # This will build the image from the Dockerfile in this directory
Sending build context to Docker daemon  2.048kB
Step 1/3 : FROM alpine
latest: Pulling from library/alpine
4fe2ade4980c: Already exists
Digest: sha256:621c2f39f8133acb8e64023a94dbdf0d5ca81896102b9e57c0dc184cadaf5528
Status: Downloaded newer image for alpine:latest
 ---> 196d12cf6ab1
Step 2/3 : RUN apk add --update redis
 ---> Running in 63ef62240ac4
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/community/x86_64/APKINDEX.tar.gz
(1/1) Installing redis (4.0.11-r0)
Executing redis-4.0.11-r0.pre-install
Executing redis-4.0.11-r0.post-install
Executing busybox-1.28.4-r1.trigger
OK: 6 MiB in 14 packages
Removing intermediate container 63ef62240ac4
 ---> 47422ba49004
Step 3/3 : CMD ["redis-server"]
 ---> Running in 08f6dd424181
Removing intermediate container 08f6dd424181
 ---> c1fd1babf388
Successfully built c1fd1babf388


ubuntu@ip-172-31-27-210:~/redis-image$ docker run c1fd1babf388
1:C 25 Oct 20:07:24.017 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
1:C 25 Oct 20:07:24.017 # Redis version=4.0.11, bits=64, commit=bca38d14, modified=0, pid=1, just started
1:C 25 Oct 20:07:24.017 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
1:M 25 Oct 20:07:24.019 * Running mode=standalone, port=6379.
1:M 25 Oct 20:07:24.019 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.
1:M 25 Oct 20:07:24.019 # Server initialized
1:M 25 Oct 20:07:24.019 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.
1:M 25 Oct 20:07:24.019 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never > /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.
1:M 25 Oct 20:07:24.019 * Ready to accept connections

# 32. Tagging an Image

ubuntu@ip-172-31-27-210:~/redis-image$ docker build -t redquacks/redis:latest .
Sending build context to Docker daemon  2.048kB
Step 1/4 : FROM alpine
 ---> 196d12cf6ab1
Step 2/4 : RUN apk add --update gcc
 ---> Using cache
 ---> 4f6e948ec8e0
Step 3/4 : RUN apk add --update redis
 ---> Using cache
 ---> 5afb124da534
Step 4/4 : CMD ["redis-server"]
 ---> Using cache
 ---> 75f85a70096c
Successfully built 75f85a70096c
Successfully tagged redquacks/redis:latest

redquacks	/			redis		:	latest
Docker ID	|	Repo/Project name	|	Version

# 33. Manual Image Generation with Docker Commit

ubuntu@ip-172-31-27-210:~$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
fafdb479ff5b        alpine              "sh"                38 seconds ago      Up 37 seconds                           condescending_montalcini
ubuntu@ip-172-31-27-210:~$ docker commit -c 'CMD ["redis-server"]' fafdb479ff5b
sha256:5b253f5bcdc6d8f640092a7e1025aa5fc984febc0619008922854cb5b37ffdd3
ubuntu@ip-172-31-27-210:~$

# This creates an Image from a running snapshot of the redis docker container 
# -c flag uses the CMD from the Dockerfile

## Section 4: Making Real Projects with Docker

# 34. Project Outline

# Dockerfile, index.js and package.json
# have been added in to the /simpleweb Folder
# this has also been added to the EC2 instance including access to this Repo

docker build . # Has been ran multiple times within the /simpleweb Folder
# Then
docker build -t quackers/simpleweb .
docker run -p 8080:8080 quackers/simpleweb

docker run -ti quackers/simpleweb sh
#or from a 2nd Command Prompt
docker exec -ti 1082e6a0a01b sh
# i.e.

/ # ubuntu@ip-172-31-27-210:~$ docker exec -ti 1082e6a0a01b sh
/usr/app # ls
Dockerfile         index.js           node_modules       package-lock.json  package.json
/usr/app #

## Section: 5 Docker Compose with Multiple Containers
# 51. Docker Compose Commands

# New Project files have been added into //Docker-K8sUdemy/visits

-rw-r--r-- 1 Rob 197609 120 Nov  2 22:39 docker-compose.yml
-rw-r--r-- 1 Rob 197609 113 Nov  2 22:24 Dockerfile
-rw-r--r-- 1 Rob 197609 478 Nov  2 22:45 index.js
-rw-r--r-- 1 Rob 197609 145 Nov  2 22:16 package.json

# Now run
docker-compose up
or 
ubuntu@ip-172-31-27-210:~/Docker-K8sUdemy/visits$ docker-compose up -d
WARNING: The Docker Engine you're using is running in swarm mode.

Compose does not use swarm mode to deploy services to multiple nodes in a swarm. All containers will be scheduled on the current node.

To deploy your application across the swarm, use `docker stack deploy`.

Starting visits_redis-server_1 ... done
Starting visits_node-app_1     ... done

ubuntu@ip-172-31-27-210:~/Docker-K8sUdemy/visits$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
76e0a58873a6        visits_node-app     "npm start"              8 minutes ago       Up 51 seconds       0.0.0.0:4001->8081/tcp   visits_node-app_1
281dec96bcf6        redis               "docker-entrypoint.s…"   8 minutes ago       Up 52 seconds       6379/tcp                 visits_redis-server_1

# Then to stop the services

ubuntu@ip-172-31-27-210:~/Docker-K8sUdemy/visits$ docker-compose down
Stopping visits_node-app_1     ... done
Stopping visits_redis-server_1 ... done
Removing visits_node-app_1     ... done
Removing visits_redis-server_1 ... done
Removing network visits_default

# 54. Automatic Container Restarts

# File changes can be seen in the commits
# Commands used were :
docker-compose up --build
docker-compose up
docker ps
#or
docker-compose ps # used only in the project directory

## Section: 6 Creating a Production Grade Workflow
# 57. Flow Specifics
# Using Github 
# Branches
# feature > pull request > master >> Travis CI >>> AWS Hosting
# Main Branch We will use: feature
# Travis CI is a hosted, distributed continuous integration service used to build and test software projects hosted at GitHub.

# 59. Project Generation
# Install nodejs in your environment
sudo apt install nodejs
sudo apt-get update
ubuntu@ip-172-31-27-210:~$ node -v
v8.10.0

sudo apt install npm
sudo apt-get update

ubuntu@ip-172-31-27-210:~$ sudo npm install -g create-react-app
/usr/local/bin/create-react-app -> /usr/local/lib/node_modules/create-react-app/index.js
/usr/local/lib
└─┬ create-react-app@2.1.1
  ├─┬ chalk@1.1.3
  │ ├── ansi-styles@2.2.1
  │ ├── escape-string-regexp@1.0.5
  │ ├─┬ has-ansi@2.0.0
  │ │ └── ansi-regex@2.1.1
  │ ├── strip-ansi@3.0.1
  │ └── supports-color@2.0.0
  ├── commander@2.18.0
  ├─┬ cross-spawn@4.0.2
  │ ├─┬ lru-cache@4.1.3
  │ │ ├── pseudomap@1.0.2
  │ │ └── yallist@2.1.2
  │ └─┬ which@1.3.1
  │   └── isexe@2.0.0
  ├── envinfo@5.10.0
  ├─┬ fs-extra@5.0.0
  │ ├── graceful-fs@4.1.15
  │ ├── jsonfile@4.0.0
  │ └── universalify@0.1.2
  ├─┬ hyperquest@2.1.3
  │ ├── buffer-from@0.1.2
  │ ├─┬ duplexer2@0.0.2
  │ │ └─┬ readable-stream@1.1.14
  │ │   ├── isarray@0.0.1
  │ │   └── string_decoder@0.10.31
  │ └─┬ through2@0.6.5
  │   ├── readable-stream@1.0.34
  │   └── xtend@4.0.1
  ├── semver@5.5.1
  ├─┬ tar-pack@3.4.1
  │ ├─┬ debug@2.6.9
  │ │ └── ms@2.0.0
  │ ├─┬ fstream@1.0.11
  │ │ ├── inherits@2.0.3
  │ │ └─┬ mkdirp@0.5.1
  │ │   └── minimist@0.0.8
  │ ├─┬ fstream-ignore@1.0.5
  │ │ └─┬ minimatch@3.0.4
  │ │   └─┬ brace-expansion@1.1.11
  │ │     ├── balanced-match@1.0.0
  │ │     └── concat-map@0.0.1
  │ ├─┬ once@1.4.0
  │ │ └── wrappy@1.0.2
  │ ├─┬ readable-stream@2.3.6
  │ │ ├── core-util-is@1.0.2
  │ │ ├── isarray@1.0.0
  │ │ ├── process-nextick-args@2.0.0
  │ │ ├── safe-buffer@5.1.2
  │ │ ├── string_decoder@1.1.1
  │ │ └── util-deprecate@1.0.2
  │ ├─┬ rimraf@2.6.2
  │ │ └─┬ glob@7.1.3
  │ │   ├── fs.realpath@1.0.0
  │ │   ├── inflight@1.0.6
  │ │   └── path-is-absolute@1.0.1
  │ ├─┬ tar@2.2.1
  │ │ └── block-stream@0.0.9
  │ └── uid-number@0.0.6
  ├─┬ tmp@0.0.33
  │ └── os-tmpdir@1.0.2
  └─┬ validate-npm-package-name@3.0.0
    └── builtins@1.0.3
















